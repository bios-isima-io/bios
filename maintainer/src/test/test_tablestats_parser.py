#
# Copyright (C) 2025 Isima, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
"""Tests the tablestats output parser"""

import os
import pprint
import sys

import pytest

from dbdozer.dbdozer_utils import parse_tablestats

EXPECTED_RESPONSE_SIMPLE = {
    "system_auth": ["resource_role_permissons_index", "role_members", "role_permissions", "roles"],
    "tfos_admin": [
        "admin",
        "admin_archived",
        "config",
        "context_migration_progress",
        "inference_records",
        "insights",
        "postprocess_records",
        "reports",
        "resource_allocation",
        "rollup_locks",
        "sketch_records",
        "tenant_appendix",
    ],
    "tfos_d_5cd226d796a83b0e8c34f4eeeb4479ce": [
        "evt_37b920054345309a81b20beee68a1e88",
        "evt_54ce677cf5aa3b71b3281f0de97bd7ff",
        "evt_5e8442b60f7b3828b4a9b553841c2500",
        "rlp_940732f32b4d303fb2bc48d8e6c094ac",
        "rlp_9886e134fac3314b9b269ea792e503ec",
        "rlp_9b3db0cefa013ec2919ed3245023b0cb",
        "sketch_blob",
        "sketch_blob_context",
        "sketch_summary",
        "sketch_summary_context",
    ],
    "tfos_d_68e4a32d10ce3b73b45ea9c9fd3185e5": [
        "cx2_4be7bbe52f46351485ea78e9824e6f04",
        "cx2_4c5fc260ce1d3be39fa4263e2f2f4829",
        "cx2_ea514e95fcfd32898d9fbdbbd81ea6b2",
        "evt_01dfa00b022031189060392297e59ff0",
        "evt_05ec16a17f263d90a849d39dfa48616d",
        "evt_061dbb8868b73e5cb25adda8c62fd7f4",
        "evt_128201816c333556b2eb5da43befcfab",
        "evt_150c449f087b334dac37f9aafce5c264",
        "evt_19c3b1cf345e3fecae44413468867c13",
        "evt_1a27e5662ec7301eaa13416a07d88a51",
        "evt_1d3790b43a7335af8db5c2b3a57fdafe",
        "evt_239003ee869d3a9486cdd58c9b820731",
        "evt_29fa3135f6783903b04f34f3b57b49cb",
        "evt_2b96e22908ef3564a45f40d39a9e9b9d",
        "evt_2ba495261d803cf689407bbd16c07338",
        "evt_2f976c93a1493803800b35926f5bfde0",
        "evt_32663a38ea1438b1ab101f35e25c6562",
        "evt_3bae5b3496683ba48e509cb4c166bc43",
        "evt_44839a8673cc3ec49b0cd66f47ee8364",
        "evt_4b1ade03c0243921b6008fba8e8f69f2",
        "evt_4be3c77cd068341dbd2663b610026275",
        "evt_4fa8f7b92b7d31ef9be6ea8247bb8b95",
        "evt_52c364a51ebc3bf1a2903e8e0b7ef796",
        "evt_579562700b8434fbbcf37322a0c69db8",
        "evt_5a700ed4d26a33a1aea9059ac4abdb26",
        "evt_5a928cd82dab3e93a64bd4bdd8d55797",
        "evt_61f1859011843c2d8e5a215dc9f4ecfa",
        "evt_68055c90d3cc3c2395c101e2adff2807",
        "evt_6b89b132a7de35d99647f2c449c8b30a",
        "evt_6c426a20ee4339dcb4a36bda368e17f3",
        "evt_6dff5f4606563bd882dff074665d696a",
        "evt_6e4a4cf1fb453f9485928c1cc495faad",
        "evt_6f8083c58ef338939535e7e498528a03",
        "evt_7039f0612a3c32d2923779e197d8023d",
        "evt_710ef197f3a83745ba8a282c5ef3a21d",
        "evt_7275336e749a36f38638df05703a03ae",
        "evt_7347ef126c4b36689acc55bb0c134cfe",
        "evt_760491a2f3ee3a54ab18a0f86b9b26ef",
        "evt_798d990b818b348b8210c6aca4ac2e28",
        "evt_7bf57915f2313d12b39df99de9d1061e",
        "evt_7d0848d2c6d83e47bcdf789061d8ac28",
        "evt_7e3fbab4200a3ef8bf57c3da4c39f805",
        "evt_8365c889754932ee863c828379f8e415",
        "evt_866d62a898c83d3db30e70497002d997",
        "evt_8708e83a5cb73656ab6acc8df9383c09",
        "evt_911047d1a9543e029765aac84a209075",
        "evt_94bbe2da974d3fa89d3e82a7293ba65f",
        "evt_96a12ff7ac6c35b1807ffba0107bb84e",
        "evt_985f140c67283f3aa96ae8290c26fe02",
        "evt_98a56409a9a03279916cc270d776db03",
        "evt_9ab54fa68df43ed2b70e25c22c4bfe13",
        "evt_a30893d08b443a3a9b538b9f4da0fb0c",
        "evt_a422d7fdb07f3c9e91d4b394951d2d08",
        "evt_a422da3c475c339e93efa0b50a1b5e0f",
        "evt_a605c781250733259ef31e0fd2469908",
        "evt_ad339d6f1eaf312ab8a6cf676208bd07",
        "evt_b5dcb66cf65435dcb696cbbbe9f40d9f",
        "evt_bd750dc549ff38a9b479c0ce226e0929",
        "evt_c277ba01e9d23037b1da3c859cf6431a",
        "evt_c61688ef7d2f3031a4cbc8b516a1df31",
        "evt_c83d0a8a038f3b999d2b211ab9bd4459",
        "evt_d6844e1173a73bef949f56dfb9ad66ab",
        "evt_d9271d4f746031fe9b217e3a9e3de4ec",
        "evt_da7a049c54f836e2a86708875f1b6494",
        "evt_df1393a8fd53342a8fc5ab5fe1054e6e",
        "evt_e96391780bb1310fb8dfdd29868c9688",
        "evt_edd7b583a3d4368abe14018bed209be5",
        "evt_f407cd541eb33b80bd98c0fd6362767d",
        "evt_f6086e92da683536b999ae386a45b9f7",
        "evt_fd6b3a231a463c53a737cfa24d30f10a",
        "idx_1acafbe5cbb73d89bd4ff6e1f29cf5b9",
        "ivw_81f8aeaec17c3b79995905099e4e7ba2",
        "rlp_02076b62348831a7a4eb318000924b70",
        "rlp_02edeee2ab2a3cf287e3cc7b65cdd8f1",
        "rlp_05098998b24d3680a3630e1d8945afba",
        "rlp_058ee3107feb34ae8a74491482e78fae",
        "rlp_0a3beb886080360186b0f8c7a10afaea",
        "rlp_0a8006016b3e3c06ae04aacdd6e98e96",
        "rlp_1322dbfa89503746bac26527c17a9c8b",
        "rlp_1445b9a5bdbf3fd8b828793803696724",
        "rlp_19223f84bafd395cb99a19b0935a976c",
        "rlp_1972a8e8298c3524a6b04b62c9b07eba",
        "rlp_19baa7dad25a3402afc472c9450fd0f0",
        "rlp_1ae9e8185e3b35de836a00725486c9ad",
        "rlp_1b80247bdc8f37f395b890eaa2bf44c5",
        "rlp_1c344b22249c346c9ea39e3b0300100e",
        "rlp_22c025cada423cdeb22b24013c605811",
        "rlp_22ccfb6ce6883bcdaae1e0f5d14e8a61",
        "rlp_230ebc3cc7003dcbbc8a77f0702070e8",
        "rlp_231e110af6023051b073d425da3c06db",
        "rlp_240052f61d1236ec90e73d15a48d7c00",
        "rlp_258ba7a599193a7582e8cf28ac934661",
        "rlp_25a2341af384377faf24cb9d401ccd41",
        "rlp_271940ff019836418d24b9a88d1aa381",
        "rlp_287d4f9ef1df30f9811b134e7a9c8dc1",
        "rlp_28a1f6cfd1273991867eef0b9fa497f0",
        "rlp_2b21b3612e1e3444b1966d0185401e84",
        "rlp_2c994673196a3e1dbfb4bcb826e87fc6",
        "rlp_2f296b765a7f3e8cb2e66cbd17a07e68",
        "rlp_2f89179ddfba3eaa8f64e68a400c00ef",
        "rlp_326131851e19325caa619efd191379f5",
        "rlp_3270975ba06a3c819b641adef0fcbc37",
        "rlp_333a9270917f36fa938cec8ba4a41482",
        "rlp_33df23626ac03911a5a73075728fb74f",
        "rlp_35db722a7b0432d68fcb7f1cbabd48c5",
        "rlp_3a637d5ba7073cbeb28a1c1575f1351b",
        "rlp_3b056b70a88c3f3c87b53ab9e76cc68d",
        "rlp_3bb4697855773967b0d6e7116e01fe9e",
        "rlp_3c5ec5f38db63c0aa9d203491cadac06",
        "rlp_3ee30d41326f3c89bf49714b3af78257",
        "rlp_3ff586b0c75b363ba253dba1d634379f",
        "rlp_4201bab8bc25333e8866526df408fe25",
        "rlp_469243ea2d1e3f0483ea1cfbc4cf8208",
        "rlp_49ee12b93ff231ceba412dc1b52dddff",
        "rlp_53e850f48f123975bb9090089db5eb7d",
        "rlp_55fcdf8a74493624af4bd7487416a159",
        "rlp_57e25e1bda5a3006b934452ac58130bd",
        "rlp_58188a7237b133cd881b706e4e8a2baf",
        "rlp_5b5b032ceb563481b6ad65f4a95f1882",
        "rlp_5d48c66f2a283dd39b51c1c7d216d7ea",
        "rlp_5f050b9e32f43a428111089a6c1a10ba",
        "rlp_628ba60f9b533737b0dc5a284b4a4d0d",
        "rlp_62b3ba5e0b0330648617c951f991149c",
        "rlp_65ab2e19cdc4337c8426fd2f19324d1b",
        "rlp_6626b304bbf935008fb4e067b6528261",
        "rlp_667087267b20393e93aef8373e214cdc",
        "rlp_6749889417673238892ffbfa5bdb33e8",
        "rlp_6963e1ea3b483d449551c822e2744dc8",
        "rlp_6b4e483ca3b33b41a5cd7acfa1aedc9a",
        "rlp_6cbb68617bd53fe79397ef5226da1831",
        "rlp_6d127481a74d3838bc08382db5b457dd",
        "rlp_6dbd34cdbb833ec0914f8f93d1450d87",
        "rlp_6f5121656d443a81b9d5a247217171a4",
        "rlp_7329eb68ceae310fa1c47b761ef78fd6",
        "rlp_733f2fa3d4c337389fd83827472939ba",
        "rlp_77ccf44afec439f8b3a7c969453cb02c",
        "rlp_78bf480ff46133cfac69ec1e7fb3da81",
        "rlp_7b16dc535a813c1f993a74e0a54a6e6f",
        "rlp_7dac112a8f3d3d048d2dbe4e362e0e63",
        "rlp_7e2598cedf813da6bf74da36e93fa668",
        "rlp_80c001ce91b638c28dbc08a1941add0d",
        "rlp_84c78d6045b332a7a9e31de6fda2c501",
        "rlp_861a19121f6333d8aefa968bcc71e8cb",
        "rlp_866e2ca5e87f37399c1363991e83a826",
        "rlp_86c02897745c357e9b4db405c65d26b0",
        "rlp_87f2b19ddc723682a0307b520dbccfe1",
        "rlp_895d5c0daeb1338cb48b1f0e342d8274",
        "rlp_8ab26a71c8dc31d5925164fccaadff72",
        "rlp_8b44b2866e06312986db02f4591fcfa4",
        "rlp_8b5cf1ed25a4389bb4be8fc1b9cf7c05",
        "rlp_8b802b573d983a438b73cec3d6b381c0",
        "rlp_91015b1238853a93bd21201171d08e52",
        "rlp_921d6dd2f21530ee964ada5801699ca7",
        "rlp_92be9db0529332efb4e4ced5f9649559",
        "rlp_92c985cba58f3e7a8f9c963e4a74eeaa",
        "rlp_96496acb332731cc8e82777135340f30",
        "rlp_9984c56431ca32d5aa8cbe42690cc9de",
        "rlp_9a9551e7ac09381b9877134d715cbe0e",
        "rlp_9b08dc11df9d308487a4cd28b2b8bbfe",
        "rlp_9b7e437d954b3467ade94360ae06dac6",
        "rlp_9c0f48580de73783b120fba5716372ff",
        "rlp_9c7c6cbeb2e13078b57227ef7a1408fa",
        "rlp_9d797be234ce315e887ca5e4584d8061",
        "rlp_9eb9c5a1f7f93cbd8306495cdc1bebab",
        "rlp_9f9a8e583d3138229cd2357d43b76cc4",
        "rlp_9fa2c73f38e536b1af2cee8cbeb061b0",
        "rlp_a0275265f4b439eb9fcd2ce0cd720a7d",
        "rlp_a451212f6cb93214ad566d23f6ff986a",
        "rlp_a6397ba0702530898f07288fdb43994b",
        "rlp_a8db6cf229e03e7caefb9ea8fe4f9a4e",
        "rlp_a9e3eeb990ad355d876fce719362e179",
        "rlp_aa57c6aee54b37789f8a685b7587cc1e",
        "rlp_aa5e575800313f4f9bf88a2b953409d2",
        "rlp_aaf384518abd3e85b9c01c5bf79cd503",
        "rlp_ab6c3c84c22e3fb48ca367a6bb8a67b9",
        "rlp_ac03cf1c34ef338c88643eeb0592be7b",
        "rlp_acebd829224b31a3bd7461aae0cdb8a7",
        "rlp_ae24eab8723836bcbf3052e00ad5e675",
        "rlp_b05ea5b93acb3dbd831830f5bfcac3a3",
        "rlp_b07b01c9afc93fc09a1fe00bb4753d50",
        "rlp_b11c23fb6d0832f0a8b902a457e1ad9e",
        "rlp_b2166e3a12f83dfdbab22ddb179f093a",
        "rlp_b503d4b94b0c392388f56b4ddcf68232",
        "rlp_b612c59384213ef5abae61d91da66a7b",
        "rlp_b7d68747b1d23f179263cadb9f17f80f",
        "rlp_bbb84e09d5b239dd8edd55775f655d00",
        "rlp_c22f92416db936f9838a626c7a20cc72",
        "rlp_c666330d9f913b9d9f435f5266091686",
        "rlp_c9cf2f0153473ffbad6a3743ae92f706",
        "rlp_d06dedd741c5395aaa8225e5c1f1767b",
        "rlp_d06fe37638153434a50ca4ca2d52e7ec",
        "rlp_d23a4dfd6a583d369cfe92cf8a93ccb2",
        "rlp_d2ba29ecce4130aa937cb8a1127f3456",
        "rlp_d33de3cf32a939b4adcbe34b44715a8c",
        "rlp_d3bb06b070053a10b361be2a34909cc4",
        "rlp_d5a220eeca633ad5aee34359b4c99992",
        "rlp_d69293c9268e3a6cb44bf7989bfbd8ae",
        "rlp_d7e0e52a0104396c8f7a827f8be3860e",
        "rlp_d81fcfdec0af3258b7c79ceeec1e0c09",
        "rlp_dc1005db18e43bf187d1ad281d81178f",
        "rlp_df5a308a2ef430ef857a5d504e92d6c0",
        "rlp_e0fe96d46b6b3befaff0f6e7f8a2db22",
        "rlp_e26507e2213f3b77bf7846da2a358265",
        "rlp_e33e596b4a6d3228b51d07fb9a0c5c1a",
        "rlp_e48d3679771a31d8927b19ee6151b2e8",
        "rlp_e7cbbcb612a43ff393db520c77d755db",
        "rlp_ea5c3d1066983b48996b0e601e0c0b12",
        "rlp_ecf6f415f833394e84b7637fdd4c1707",
        "rlp_ed23eef788973a8783daff7146ef7f6c",
        "rlp_eec0eb8971c23fd6aa79eca8783a29a6",
        "rlp_eee588ad890939219438be592eea585a",
        "rlp_f17e5d0b74ee3ae299f4c1c3ff5b3ab2",
        "rlp_f5366130101030eeba4ca3d7a402b8a5",
        "rlp_f81585b5d971324b818922ca45c465c8",
        "rlp_fccebb11e1313e0aa68975778dc9f972",
        "rlp_fffc35b0648332edbc622c47929b7e0c",
        "sketch_blob",
        "sketch_blob_context",
        "sketch_summary",
        "sketch_summary_context",
    ],
}


@pytest.fixture(scope="module", name="tablestats_output")
def before_all():
    """Sets up the test module"""
    current_dir = os.path.dirname(os.path.abspath(__file__))
    source_file_name = current_dir + "/tablestats.txt"
    with open(source_file_name, "r", encoding="utf-8") as file:
        src = file.read()

    return src


def test_tablestats_parser_simple(tablestats_output):
    """Test the simple parser"""
    keyspaces_to_exclude = ["system", "system_schema"]
    out = parse_tablestats(tablestats_output, keyspaces_to_exclude)
    pprint.pprint(out)
    assert out == EXPECTED_RESPONSE_SIMPLE


def test_tablestats_parser_detail(tablestats_output):
    """Test the simple parser"""
    keyspaces_to_exclude = ["system", "system_schema"]
    out = parse_tablestats(tablestats_output, keyspaces_to_exclude, detail=True)
    # pprint.pprint(out)
    assert "tfos_d_68e4a32d10ce3b73b45ea9c9fd3185e5" in out
    keyspace_info = out["tfos_d_68e4a32d10ce3b73b45ea9c9fd3185e5"]
    assert "evt_061dbb8868b73e5cb25adda8c62fd7f4" in keyspace_info
    table_info = keyspace_info["evt_061dbb8868b73e5cb25adda8c62fd7f4"]

    expected_table_info = {
        "sstables": 79,
        "spaceLive": 168924236832,
        "spaceTotal": 168924236832,
        "spaceSnapshots": 0,
        "totalOffHeapMemory": 61760732,
        "sstableCompressionRatio": 0.3331773630616796,
        "partitions": 15518,
        "memtableCells": 15555,
        "memtableDataSize": 32899967,
        "memtableOffHeapMemory": 0,
        "memtableSwitches": 121,
        "localReads": 736,
        "localReadLatency": 142514,
        "localWrites": 3367727,
        "localWriteLatency": 40,
        "pendingFlushes": 0,
        "percentRepaired": 84.98,
        "bloomFilterFalsePositives": 27,
        "bloomFilterFalseRatio": 0.00000,
        "bloomFilterSpaceUsed": 20792,
        "bloomFilterOffHeapMemory": 20160,
        "indexSummaryOffHeapMemory": 3620,
        "compressionMetadataOffHeapMemory": 61736952,
        "compactedPartitionMinimumBytes": 219343,
        "compactedPartitionMaximumBytes": 186563160,
        "compactedPartitionMeanBytes": 35272984,
        "averageLiveCellsPerSlice": 5722.0,
        "maximumLiveCellsPerSlice": 5722,
        "averageTombstonesPerSlice": 1.0,
        "maximumTombstonesPerSlice": 1,
        "droppedMutations": 0,
    }
    assert table_info == expected_table_info


if __name__ == "__main__":
    pytest.main(sys.argv)
